<!DOCTYPE html> 
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Gestión Productos</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

        <style>
            body {
                padding-top: 60px;
                background: #723d27;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                font-family: "Georgia", serif;
            }

            .container {
                margin-top: 90px;
                background-color: #9e834f;
                border-radius: 10px;
                width: 90%;
                padding: 20px 25px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                color: whitesmoke;
            }

            th, td {
                border: 1px solid whitesmoke;
                text-align: center;
                padding: 8px;
                color: whitesmoke;
            }

            .navbar-custom {
                background-color: #522f14;
            }

            button {
                background-color: #58352c;
                border: #5A3E36;
                border-radius: 10px;
                text-align: center;
                margin: 5px;
                padding: 7px 15px;
                color: whitesmoke;
            }
        </style>
        <script>
            listaProductos = [];

            let productoSeleccionadoId = null;
            function seleccionarProducto(id) {
                productoSeleccionadoId = id;
            }

            function cargarProductos(){
                    let q = `
                        query {
                            getProductos {
                                id
                                nombre
                                precio
                                disponible
                            }
                        }`;
                    $.ajax({
                        type: "POST",
                        url: "http://localhost:8159/graphql",
                        contentType: "application/json",
                        data: JSON.stringify({
                            query : q
                        }),
                        success: function(response){
                            listaProductos = response?.data?.getProductos ?? [];
                            renderProductosTabla(listaProductos, "contenedorProductos");
                        }
                    })
                }

                function renderProductosTabla(productos, containerId){
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    container.textContent = "";

                    if (!productoSeleccionadoId) {
                        alert("Error: no se ha seleccionado ningún producto");
                        return;
                    }

                    const formatoCLP = new Intl.NumberFormat("es-CL", {
                    style: "currency",
                    currency: "CLP"
                });

                    if (productos.length === 0){
                        const p = document.createElement("p"); 
                        p.textContent = "Sin productos registrados";
                        container.appendChild(p);
                        return;
                    }
                    const table = document.createElement("table");
                    table.className = "table";
                    const thead = document.createElement("thead");
                    const headerRow = document.createElement("tr");
                    ['Producto', 'Precio', 'Disponible', 'Accion'].forEach((col) => {
                        const th = document.createElement("th");
                        th.textContent = col;
                        headerRow.appendChild(th);
                    })
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement("tbody");

                    for (const p of productos){
                        const tr = document.createElement("tr");
                        const tdProducto = document.createElement("td");
                        const precioCLP = document.createElement("td");
                        const tdDisponible = document.createElement("td");
                        const tdAccion = document.createElement("td");
                        tdProducto.textContent = p.id ?? '';
                        precioCLP.textContent = formatoCLP.format(p.precio) ?? '';
                        tdDisponible.textContent = p.disponible ?? ''; 
                        tdAccion.innerHTML = `
                            <button type="button" 
                                    class="btn" 
                                    data-toggle="modal" 
                                    data-target="#editarModal"
                                    onclick="seleccionarProducto('${p.id}')">
                                Editar
                            </button>`;
                        tr.appendChild(tdProducto);
                        tr.appendChild(precioCLP);
                        tr.appendChild(tdDisponible);
                        tr.appendChild(tdAccion);
                        tbody.appendChild(tr);
                    }
                    table.appendChild(tbody);
                    table.style.borderCollapse = 'collapse';
                    table.querySelectorAll('th, td').forEach((cell) => {
                        cell.style.border = '1px solid whitesmoke';
                    });
                    container.appendChild(table);
                }

            function edi(){
                let nombre = document.getElementById("nombreProducto").value.trim();
                let precio = document.getElementById("precioProducto").value.trim();
                let disponible = document.getElementById("disponible").value === "Sí";

                if (nombre === "" || precio === "") {
                    alert("Faltan datos");
                    return;
                }
                const prod = listaProductos.find(p => p.nombre === nombre);

                if (!prod) {
                    alert("Producto no encontrado");
                    return;
                }

                let q = `
                    mutation {
                        updProducto(
                            id: "${productoSeleccionadoId}",
                            input: {
                                nombre: "${nombre}",
                                precio: ${precio},
                                disponible: ${disponible}
                            }
                        ) {
                            id
                            nombre
                            precio
                            disponible
                        }
                    }`;
                $.ajax({
                    type: "POST",
                    url: "http://localhost:8159/graphql",
                    contentType: "application/json",
                    data: JSON.stringify({ query: q }),
                    success: function(response){
                        alert("Producto editado");
                        cargarProductos();
                        $('#editarModal').modal('hide');
                    }
                });
            }
        </script>
    </head>
    <body onload="cargarProductos()">

        <nav class="navbar navbar-expand-sm navbar-dark fixed-top navbar-custom">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Gestión Productos</a>
            </div>
        </nav>

        <div class="container border" id="contenedorProductos"></div>

        <div class="modal fade" id="editarModal" tabindex="-1" role="dialog" aria-labelledby="editarModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content" style="color:#5A3E36">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editarModalLabel">Editar producto</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="nombreProducto">Nombre del producto</label>
                                <input type="text" class="form-control" id="nombreProducto" placeholder="Ej: Onion Rings (8 unds.)">
                            </div>
                            <div class="form-group">
                                <label for="precioProducto">Precio</label>
                                <input type="text" class="form-control" id="precioProducto" placeholder="Ej: 12300">
                            </div>
                            <div class="form-group">
                                <label for="disponible">Disponible</label>
                                <select class="form-control" id="disponible">
                                    <option>Sí</option>
                                    <option>No</option>
                                </select>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" data-dismiss="modal">Cancelar</button>
                        <button type="button" onclick="edi()">Editar</button>
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
